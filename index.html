<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Wawancara Pasca Masa Jeda Pegawai</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f4f7fb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .card { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); border: none; margin-bottom: 20px; }
    .card-header { color:#fff; font-weight:700; border: none; border-radius: 12px 12px 0 0 !important; }
    .progress { height:22px; border-radius:12px; overflow:hidden; }
    textarea { border-radius:8px; resize: vertical; }
    .is-invalid { border-color:#dc3545 !important; }
    .btn-submit { font-weight: 600; padding: 12px; }
    .audio-player { width: 100%; margin: 15px 0; }
    .audio-container { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
    .audio-instruction { font-size: 0.9em; color: #6c757d; margin-top: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body class="p-3">

<div class="container" style="max-width:900px;">
  <div class="text-center mb-4">
    <h3 class="fw-bold text-primary">TEST WAWANCARA PASCA MASA JEDA PEGAWAI</h3>
    <p class="text-muted">Dengarkan audio pertanyaan dan isi jawaban dengan lengkap</p>
  </div>

  <!-- Progress Bar -->
  <div class="progress mb-4">
    <div id="progressBar" class="progress-bar bg-success" style="width:0%">0%</div>
  </div>

  <form id="formWawancara">

    <!-- DATA DIRI -->
    <div class="card">
      <div class="card-header bg-primary">Section 1 — Data Diri</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama *</label>
            <input name="nama" class="form-control required" placeholder="Masukkan nama lengkap" />
          </div>
          <div class="col-md-6">
            <label class="form-label">NPP *</label>
            <input name="npp" class="form-control required" placeholder="Masukkan NPP" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Divisi *</label>
            <select name="divisi" class="form-select required">
              <option value="">-- Pilih Divisi --</option>
              <option>HCC</option><option>INA</option><option>SBD</option><option>MBS</option>
              <option>PLM</option><option>OPS</option><option>OPR1</option><option>OPR2</option>
              <option>FRM</option><option>CSI</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Region *</label>
            <select name="region" class="form-select required">
              <option value="">-- Pilih Region --</option>
              <option>Region 1</option><option>Region 2</option><option>Region 3</option>
              <option>Region 4</option><option>Region 5</option><option>Region 6</option>
              <option>Region 7</option><option>Region 8</option><option>Region 9</option>
              <option>Region 10</option><option>Kantor Pusat</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">COU</label>
            <input name="cou" class="form-control" placeholder="Opsional" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Jabatan *</label>
            <select name="jabatan" class="form-select required">
              <option value="">-- Pilih Jabatan --</option>
              <option>CEO</option><option>Deputy</option><option>Senior Manager</option>
              <option>Manager</option><option>Supervisor</option><option>Staf</option>
              <option>Lainnya</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- SOAL 1-8 (AUDIO ONLY) -->
    <div class="card">
      <div class="card-header bg-success">Section 2 — Pertanyaan Wawancara</div>
      <div class="card-body">
        <p class="text-muted mb-4">Dengarkan setiap pertanyaan audio di bawah ini dan tulis jawaban Anda pada kolom yang tersedia.</p>
        
        <div id="soalContainer"></div>
      </div>
    </div>

    <!-- SUBMIT -->
    <div class="d-grid mb-5">
      <button type="submit" class="btn btn-success btn-lg btn-submit">
        <span id="submitText">KIRIM SEMUA JAWABAN</span>
        <div id="submitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
      </button>
    </div>
  </form>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white border-0">
        <h5 class="modal-title">Terima Kasih!</h5>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#28a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h4 class="text-success mb-3">Data Anda sudah tersimpan!</h4>
        <p class="text-muted">Terima kasih telah mengisi form wawancara ini.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-success w-100" data-bs-dismiss="modal" onclick="resetForm()">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Gagal</h5>
      </div>
      <div class="modal-body">
        <p id="errorMessage">Terjadi kesalahan saat mengirim data.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden iframe untuk submit -->
<iframe name="hiddenFrame" class="hidden"></iframe>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Web App URL - GANTI dengan URL Anda
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwPYvDVLuuMHnpI9gR334UFVyleyekRKa10uUiNrtU6_EJPK-v5bQWwa0EVwbZyQAct/exec";
const TOTAL_SOAL = 8;

// Function untuk mendapatkan source audio
function audioSrc(i) {
  return `soal${i}.mp3`;
}

// Generate soal dengan audio saja
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('soalContainer');
  
  for (let i = 1; i <= TOTAL_SOAL; i++) {
    container.insertAdjacentHTML('beforeend', `
      <div class="audio-container mb-4">
        <h6 class="fw-bold text-primary mb-3">Soal ${i}</h6>
        <audio controls class="audio-player">
          <source src="${audioSrc(i)}" type="audio/mpeg">
          Browser Anda tidak mendukung pemutar audio.
        </audio>
        <div class="audio-instruction">Dengarkan pertanyaan di atas kemudian tulis jawaban Anda di bawah</div>
        <label class="form-label mt-3">Jawaban Soal ${i} *</label>
        <textarea name="jawaban${i}" class="form-control required" rows="4" placeholder="Tulis jawaban Anda di sini..."></textarea>
      </div>
    `);
  }
  
  attachProgressListeners();
  updateProgress();
});

// Progress tracking
function attachProgressListeners() {
  document.querySelectorAll('.required').forEach(el => {
    el.addEventListener('input', updateProgress);
    el.addEventListener('change', updateProgress);
  });
}

function updateProgress() {
  const required = document.querySelectorAll('.required');
  let filled = 0;
  
  required.forEach(f => {
    if (f.type === 'select-one') {
      if (f.value && f.value !== "") filled++;
    } else {
      if (f.value && f.value.toString().trim() !== "") filled++;
    }
  });
  
  const percent = required.length ? Math.round((filled / required.length) * 100) : 0;
  const bar = document.getElementById('progressBar');
  bar.style.width = percent + '%';
  bar.innerText = percent + '%';
  
  // Update progress bar color
  if (percent < 50) {
    bar.className = 'progress-bar bg-danger';
  } else if (percent < 100) {
    bar.className = 'progress-bar bg-warning';
  } else {
    bar.className = 'progress-bar bg-success';
  }
}

// Form submission dengan iframe
function showLoading(show) {
  const btn = document.querySelector('.btn-submit');
  const text = document.getElementById('submitText');
  const spinner = document.getElementById('submitSpinner');
  
  if (show) {
    btn.disabled = true;
    text.textContent = 'MENGIRIM...';
    spinner.classList.remove('d-none');
  } else {
    btn.disabled = false;
    text.textContent = 'KIRIM SEMUA JAWABAN';
    spinner.classList.add('d-none');
  }
}

function resetForm() {
  document.getElementById('formWawancara').reset();
  updateProgress();
  window.scrollTo({top:0, behavior:'smooth'});
}

document.getElementById('formWawancara').addEventListener('submit', function(e) {
  e.preventDefault();

  // Validation
  const required = document.querySelectorAll('.required');
  let ok = true;
  let firstInvalid = null;
  
  required.forEach(f => {
    const isEmpty = f.type === 'select-one' ? 
      (!f.value || f.value === "") : 
      (!f.value || f.value.toString().trim() === "");
    
    if (isEmpty) {
      f.classList.add('is-invalid');
      if (!firstInvalid) firstInvalid = f;
      ok = false;
    } else {
      f.classList.remove('is-invalid');
    }
  });
  
  if (!ok) {
    firstInvalid.focus();
    alert('Harap lengkapi semua field yang wajib diisi!');
    return;
  }

  // Prepare data untuk GET parameters
  const formData = new FormData(this);
  const params = new URLSearchParams();
  
  for (const [key, value] of formData.entries()) {
    params.append(key, value);
  }

  // Add all jawaban fields
  for (let i = 1; i <= TOTAL_SOAL; i++) {
    if (!params.has('jawaban' + i)) {
      params.append('jawaban' + i, '');
    }
  }

  const urlWithParams = WEBAPP_URL + '?' + params.toString();
  console.log('Sending GET request to:', urlWithParams);

  // Show loading
  showLoading(true);

  // Gunakan img tag untuk menghindari CORS
  const img = new Image();
  img.src = urlWithParams;
  
  // Set timeout untuk menunggu response
  setTimeout(function() {
    showLoading(false);
    // Anggap selalu sukses karena kita tidak bisa mendapatkan response due to CORS
    new bootstrap.Modal(document.getElementById('successModal')).show();
  }, 2000);
});

// Alternative: Gunakan form target iframe (lebih reliable)
function submitWithIframe() {
  const form = document.getElementById('formWawancara');
  const originalAction = form.action;
  const originalMethod = form.method;
  const originalTarget = form.target;
  
  // Set form untuk submit ke iframe
  form.action = WEBAPP_URL;
  form.method = 'GET';
  form.target = 'hiddenFrame';
  
  // Submit form
  form.submit();
  
  // Restore original values
  setTimeout(() => {
    form.action = originalAction;
    form.method = originalMethod;
    form.target = originalTarget;
    showLoading(false);
    new bootstrap.Modal(document.getElementById('successModal')).show();
  }, 3000);
}
</script>
</body>
</html>
