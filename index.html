<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Wawancara Pasca Masa Jeda Pegawai</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f4f7fb; }
    .card { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .card-header { color:#fff; font-weight:700; }
    .progress { height:22px; border-radius:12px; overflow:hidden; }
    textarea { border-radius:8px; }
    .is-invalid { border-color:#dc3545 !important; box-shadow:none !important; }
  </style>
</head>
<body class="p-3">

<div class="container" style="max-width:900px;">
  <h3 class="text-center fw-bold mb-4 text-primary">TEST WAWANCARA PASCA MASA JEDA PEGAWAI</h3>

  <!-- Progress -->
  <div class="progress mb-4">
    <div id="progressBar" class="progress-bar bg-success" style="width:0%">0%</div>
  </div>

  <form id="formWawancara">

    <!-- DATA DIRI -->
    <div class="card mb-4">
      <div class="card-header bg-primary">Section 1 — Data Diri</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nama *</label>
            <input name="nama" id="nama" class="form-control required" />
          </div>
          <div class="col-md-6">
            <label class="form-label">NPP *</label>
            <input name="npp" id="npp" class="form-control required" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Divisi *</label>
            <select name="divisi" id="divisi" class="form-select required">
              <option value="">-- Pilih Divisi --</option>
              <option>HCC</option><option>INA</option><option>SBD</option><option>MBS</option>
              <option>PLM</option><option>OPS</option><option>OPR1</option><option>OPR2</option>
              <option>FRM</option><option>CSI</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Region *</label>
            <select name="region" id="region" class="form-select required">
              <option value="">-- Pilih Region --</option>
              <option>Region 1</option><option>Region 2</option><option>Region 3</option>
              <option>Region 4</option><option>Region 5</option><option>Region 6</option>
              <option>Region 7</option><option>Region 8</option><option>Region 9</option>
              <option>Region 10</option><option>Kantor Pusat</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">COU</label>
            <input name="cou" id="cou" class="form-control" />
          </div>

          <div class="col-md-6">
            <label class="form-label">Jabatan *</label>
            <select name="jabatan" id="jabatan" class="form-select required">
              <option value="">-- Pilih Jabatan --</option>
              <option>CEO</option><option>Deputy</option><option>Senior Manager</option>
              <option>Manager</option><option>Supervisor</option><option>Staf</option>
              <option>Lainnya</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- SOAL 1..8 (Audio + Textarea) -->
    <div id="soalContainer"></div>

    <!-- SUBMIT -->
    <div class="d-grid mb-5">
      <button type="submit" id="btnSubmit" class="btn btn-success btn-lg">KIRIM SEMUA JAWABAN</button>
    </div>
  </form>
</div>

<!-- Loading modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="spinner-border text-primary mb-3" style="width:3rem;height:3rem;" role="status"></div>
      <div><strong>Mengirim jawaban...</strong></div>
    </div>
  </div>
</div>

<!-- Success modal -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h4 class="text-success mb-2">✔ Berhasil!</h4>
      <p>Jawaban Anda telah diterima. Terima kasih.</p>
      <button class="btn btn-primary w-100" data-bs-dismiss="modal" onclick="resetForm()">OK</button>
    </div>
  </div>
</div>

<!-- Error modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="text-danger mb-2">Gagal mengirim</h5>
      <p id="errorText">Terjadi kesalahan. Silakan coba lagi.</p>
      <button class="btn btn-secondary w-100" data-bs-dismiss="modal">Tutup</button>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================== CONFIG ==================
   Ganti audioPattern atau isi audio/soal1..8.mp3 sesuai link Anda.
   WebApp URL sudah Anda berikan dan saya masukkan di bawah.
=============================================*/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU2_-CYYOA0AVtqPNuraC8LYqtfls9I_IvBcCR9eimZsOoyUx2WQ8P9k4sKdVJ9PNJ/exec";
const TOTAL_SOAL = 8;
const AUDIO_PREFIX = "soal"; // default uses local files soal1.mp3 .. soal8.mp3
// Jika Anda punya hosted audio, set AUDIO_PREFIX = "https://drive.google.com/uc?export=download&id=FILE_ID_FOLDER_OR_BASE"

function audioSrc(i){
  // default relative files: "soal1.mp3"
  return `${AUDIO_PREFIX}${i}.mp3`;
}

/* ===== generate soal blocks ===== */
document.addEventListener('DOMContentLoaded', ()=> {
  const container = document.getElementById('soalContainer');
  for (let i=1;i<=TOTAL_SOAL;i++){
    container.insertAdjacentHTML('beforeend', `
      <div class="card mb-3">
        <div class="card-header ${i%4===1? 'bg-warning': i%4===2? 'bg-info' : i%4===3? 'bg-danger' : 'bg-primary'}">
          Soal ${i}
        </div>
        <div class="card-body">
          <audio controls class="w-100 mb-2">
            <source src="${audioSrc(i)}" type="audio/mpeg">
            Audio tidak didukung.
          </audio>
          <label class="form-label">Jawaban Soal ${i} *</label>
          <textarea name="jawaban${i}" id="jawab${i}" class="form-control required" rows="4"></textarea>
        </div>
      </div>
    `);
  }

  // attach listeners for progress
  attachProgressListeners();
  updateProgress();
});

/* ===== progress logic ===== */
function attachProgressListeners(){
  document.querySelectorAll('.required').forEach(el=>{
    el.addEventListener('input', updateProgress);
  });
}
function updateProgress(){
  const required = document.querySelectorAll('.required');
  let filled = 0;
  required.forEach(f=>{
    if (f.value && f.value.toString().trim() !== "") filled++;
  });
  const percent = required.length ? Math.round((filled / required.length)*100) : 0;
  const bar = document.getElementById('progressBar');
  bar.style.width = percent + '%';
  bar.innerText = percent + '%';
}

/* ===== form submit with loading, timeout, success/error handling ===== */
function timeoutPromise(ms, promise){
  return new Promise((resolve, reject) => {
    const id = setTimeout(() => {
      clearTimeout(id);
      reject(new Error('timeout'));
    }, ms);
    promise.then(
      (res) => { clearTimeout(id); resolve(res); },
      (err) => { clearTimeout(id); reject(err); }
    );
  });
}

function resetForm(){
  document.getElementById('formWawancara').reset();
  updateProgress();
  window.scrollTo({top:0, behavior:'smooth'});
}

document.getElementById('formWawancara').addEventListener('submit', async function(evt){
  evt.preventDefault();

  // validation
  const required = document.querySelectorAll('.required');
  let ok = true;
  required.forEach(f=>{
    if (!f.value || f.value.toString().trim()===""){
      f.classList.add('is-invalid');
      ok = false;
    } else {
      f.classList.remove('is-invalid');
    }
  });
  if (!ok) {
    const first = document.querySelector('.is-invalid');
    first?.focus();
    return;
  }

  // gather payload
  const form = new FormData(this);
  const payload = {};
  for (const [k,v] of form.entries()) payload[k] = v;

  // ensure jawaban1..8 present
  for (let i=1;i<=TOTAL_SOAL;i++){
    if (!( 'jawaban'+i in payload )) payload['jawaban'+i] = "";
  }

  // show loading modal
  const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
  loadingModal.show();

  try {
    // fetch with timeout (20s)
    const resp = await timeoutPromise(20000, fetch(WEBAPP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      // keep default mode: no 'mode' override -> Apps Script webapp supports CORS when deployed correctly
    }));

    // try parse response (if any)
    let text = '';
    try { text = await resp.text(); } catch(e){ text = ''; }

    // hide loading
    loadingModal.hide();

    // show success
    new bootstrap.Modal(document.getElementById('successModal')).show();

  } catch (err) {
    loadingModal.hide();
    console.error('Submit error:', err);

    // display friendly error
    const errModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errText = document.getElementById('errorText');
    if (err.message && err.message.toLowerCase().includes('timeout')) {
      errText.innerText = 'Koneksi terlalu lambat (timeout). Silakan coba lagi.';
    } else {
      errText.innerText = 'Gagal mengirim jawaban. Periksa koneksi atau URL Web App Anda.';
    }
    errModal.show();
  }
});
</script>

</body>
</html>
